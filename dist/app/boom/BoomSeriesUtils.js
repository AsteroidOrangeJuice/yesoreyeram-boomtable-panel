System.register(["lodash", "./index", "./../GrafanaUtils"], function (exports_1, context_1) {
    "use strict";
    var lodash_1, index_1, GrafanaUtils_1, getBGColor, getTextColor, getThresholds, getLink, doesValueNeedsToHide, GetValuesReplaced;
    var __moduleName = context_1 && context_1.id;
    return {
        setters: [
            function (lodash_1_1) {
                lodash_1 = lodash_1_1;
            },
            function (index_1_1) {
                index_1 = index_1_1;
            },
            function (GrafanaUtils_1_1) {
                GrafanaUtils_1 = GrafanaUtils_1_1;
            }
        ],
        execute: function () {
            exports_1("getBGColor", getBGColor = function (value, pattern, thresholds, list_of_bgColors_based_on_thresholds, bgColorOverRides) {
                var bgColor = "transparent";
                if (lodash_1.default.isNaN(value) || value === null) {
                    bgColor = pattern.null_color || "darkred";
                    if (pattern.null_color === "") {
                        bgColor = "transparent";
                    }
                }
                else {
                    bgColor = pattern.defaultBGColor || bgColor;
                    if (pattern.enable_bgColor && pattern.bgColors) {
                        bgColor = index_1.getItemBasedOnThreshold(thresholds, list_of_bgColors_based_on_thresholds, value, bgColor);
                    }
                    if (pattern.enable_bgColor_overrides && pattern.bgColors_overrides !== "") {
                        var _bgColors_overrides = bgColorOverRides.filter(function (con) { return con.indexOf("->"); }).map(function (con) { return con.split("->"); }).filter(function (con) { return +(con[0]) === value; }).map(function (con) { return con[1]; });
                        if (_bgColors_overrides.length > 0 && _bgColors_overrides[0] !== "") {
                            bgColor = ("" + _bgColors_overrides[0]).trim();
                        }
                    }
                }
                return index_1.normalizeColor(bgColor);
            });
            exports_1("getTextColor", getTextColor = function (value, pattern, thresholds, list_of_textColors_based_on_thresholds, txtColorOverrides) {
                var textColor = document.body.classList.contains("theme-light") ? "black" : "white";
                if (lodash_1.default.isNaN(value) || value === null) {
                    textColor = pattern.null_textcolor || textColor;
                }
                else {
                    textColor = pattern.defaultTextColor || textColor;
                    if (pattern.enable_textColor && pattern.textColors) {
                        textColor = index_1.getItemBasedOnThreshold(thresholds, list_of_textColors_based_on_thresholds, value, textColor);
                    }
                    if (pattern.enable_textColor_overrides && pattern.textColors_overrides !== "") {
                        var _textColors_overrides = txtColorOverrides.filter(function (con) { return con.indexOf("->"); }).map(function (con) { return con.split("->"); }).filter(function (con) { return +(con[0]) === value; }).map(function (con) { return con[1]; });
                        if (_textColors_overrides.length > 0 && _textColors_overrides[0] !== "") {
                            textColor = ("" + _textColors_overrides[0]).trim();
                        }
                    }
                }
                return index_1.normalizeColor(textColor);
            });
            exports_1("getThresholds", getThresholds = function (thresholdsArray, enable_time_based_thresholds, time_based_thresholds, currentTimeStamp) {
                if (enable_time_based_thresholds) {
                    var metricrecivedTimeStamp_1 = currentTimeStamp || new Date();
                    var metricrecivedTimeStamp_innumber_1 = metricrecivedTimeStamp_1.getHours() * 100 + metricrecivedTimeStamp_1.getMinutes();
                    var weekdays_1 = ["sun", "mon", "tue", "wed", "thu", "fri", "sat"];
                    lodash_1.default.each(time_based_thresholds, function (tbtx) {
                        if (tbtx && tbtx.from && tbtx.to && tbtx.enabledDays &&
                            (metricrecivedTimeStamp_innumber_1 >= +(tbtx.from)) &&
                            (metricrecivedTimeStamp_innumber_1 <= +(tbtx.to)) &&
                            (tbtx.enabledDays.toLowerCase().indexOf(weekdays_1[metricrecivedTimeStamp_1.getDay()]) > -1) &&
                            tbtx.threshold) {
                            thresholdsArray = (tbtx.threshold + "").split(",").map(function (d) { return +d; });
                        }
                    });
                }
                return thresholdsArray || [];
            });
            exports_1("getLink", getLink = function (enable_clickable_cells, clickable_cells_link, range) {
                var link = enable_clickable_cells ? clickable_cells_link || "#" : "#";
                if (link && link !== "#") {
                    link += (link.indexOf("?") > -1 ? "&from=" + range.from : "?from=" + range.from);
                    link += "&to=" + range.to;
                }
                return link;
            });
            exports_1("doesValueNeedsToHide", doesValueNeedsToHide = function (value, filter) {
                var hidden = false;
                if ((value || value === 0) && filter && (filter.value_below !== "" || filter.value_above !== "")) {
                    if (filter.value_below !== "" && value < +(filter.value_below)) {
                        hidden = true;
                    }
                    if (filter.value_above !== "" && value > +(filter.value_above)) {
                        hidden = true;
                    }
                }
                return hidden;
            });
            exports_1("GetValuesReplaced", GetValuesReplaced = function (strToReplace, value, valueformatted, stats, decimals, format, _metricname, _tags, delimiter) {
                var value_raw = lodash_1.default.isNaN(value) || value === null ? "null" : value.toString().trim();
                var value_formatted = lodash_1.default.isNaN(value) || value === null ? "null" : valueformatted.toString().trim();
                strToReplace = strToReplace.replace(new RegExp("_value_min_raw_", "g"), stats.min);
                strToReplace = strToReplace.replace(new RegExp("_value_max_raw_", "g"), stats.max);
                strToReplace = strToReplace.replace(new RegExp("_value_avg_raw_", "g"), stats.avg);
                strToReplace = strToReplace.replace(new RegExp("_value_current_raw_", "g"), stats.current);
                strToReplace = strToReplace.replace(new RegExp("_value_total_raw_", "g"), stats.total);
                strToReplace = strToReplace.replace(new RegExp("_value_raw_", "g"), value_raw);
                strToReplace = strToReplace.replace(new RegExp("_value_min_", "g"), GrafanaUtils_1.get_formatted_value(stats.min, decimals, format));
                strToReplace = strToReplace.replace(new RegExp("_value_max_", "g"), GrafanaUtils_1.get_formatted_value(stats.max, decimals, format));
                strToReplace = strToReplace.replace(new RegExp("_value_avg_", "g"), GrafanaUtils_1.get_formatted_value(stats.avg, decimals, format));
                strToReplace = strToReplace.replace(new RegExp("_value_current_", "g"), GrafanaUtils_1.get_formatted_value(stats.current, decimals, format));
                strToReplace = strToReplace.replace(new RegExp("_value_total_", "g"), GrafanaUtils_1.get_formatted_value(stats.total, decimals, format));
                strToReplace = strToReplace.replace(new RegExp("_value_", "g"), value_formatted);
                if (delimiter.toLowerCase() === "tag") {
                    strToReplace = strToReplace.replace(new RegExp("{{metric_name}}", "g"), _metricname);
                    strToReplace = index_1.replace_tags_from_field(strToReplace, _tags);
                }
                return strToReplace;
            });
        }
    };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQm9vbVNlcmllc1V0aWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2FwcC9ib29tL0Jvb21TZXJpZXNVdGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztZQU9BLHdCQUFXLFVBQVUsR0FBRyxVQUFVLEtBQWEsRUFBRSxPQUFxQixFQUFFLFVBQWlCLEVBQUUsb0NBQThDLEVBQUUsZ0JBQTBCO2dCQUNqSyxJQUFJLE9BQU8sR0FBRyxhQUFhLENBQUM7Z0JBQzVCLElBQUksZ0JBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksS0FBSyxLQUFLLElBQUksRUFBRTtvQkFDbEMsT0FBTyxHQUFHLE9BQU8sQ0FBQyxVQUFVLElBQUksU0FBUyxDQUFDO29CQUMxQyxJQUFJLE9BQU8sQ0FBQyxVQUFVLEtBQUssRUFBRSxFQUFFO3dCQUMzQixPQUFPLEdBQUcsYUFBYSxDQUFDO3FCQUMzQjtpQkFDSjtxQkFBTTtvQkFDSCxPQUFPLEdBQUcsT0FBTyxDQUFDLGNBQWMsSUFBSSxPQUFPLENBQUM7b0JBQzVDLElBQUksT0FBTyxDQUFDLGNBQWMsSUFBSSxPQUFPLENBQUMsUUFBUSxFQUFFO3dCQUM1QyxPQUFPLEdBQUcsK0JBQXVCLENBQUMsVUFBVSxFQUFFLG9DQUFvQyxFQUFFLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztxQkFFdkc7b0JBQ0QsSUFBSSxPQUFPLENBQUMsd0JBQXdCLElBQUksT0FBTyxDQUFDLGtCQUFrQixLQUFLLEVBQUUsRUFBRTt3QkFDdkUsSUFBSSxtQkFBbUIsR0FBRyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsVUFBQSxHQUFHLElBQUksT0FBQSxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFqQixDQUFpQixDQUFDLENBQUMsR0FBRyxDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBZixDQUFlLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBQSxHQUFHLElBQUksT0FBQSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssS0FBSyxFQUFuQixDQUFtQixDQUFDLENBQUMsR0FBRyxDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFOLENBQU0sQ0FBQyxDQUFDO3dCQUM5SixJQUFJLG1CQUFtQixDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksbUJBQW1CLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFOzRCQUNqRSxPQUFPLEdBQUcsQ0FBQyxFQUFFLEdBQUcsbUJBQW1CLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQzt5QkFDbEQ7cUJBQ0o7aUJBQ0o7Z0JBQ0QsT0FBTyxzQkFBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ25DLENBQUMsRUFBQztZQUNGLDBCQUFXLFlBQVksR0FBRyxVQUFVLEtBQWEsRUFBRSxPQUFxQixFQUFFLFVBQVUsRUFBRSxzQ0FBOEMsRUFBRSxpQkFBMkI7Z0JBQzdKLElBQUksU0FBUyxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7Z0JBQ3BGLElBQUksZ0JBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksS0FBSyxLQUFLLElBQUksRUFBRTtvQkFDbEMsU0FBUyxHQUFHLE9BQU8sQ0FBQyxjQUFjLElBQUksU0FBUyxDQUFDO2lCQUNuRDtxQkFBTTtvQkFDSCxTQUFTLEdBQUcsT0FBTyxDQUFDLGdCQUFnQixJQUFJLFNBQVMsQ0FBQztvQkFDbEQsSUFBSSxPQUFPLENBQUMsZ0JBQWdCLElBQUksT0FBTyxDQUFDLFVBQVUsRUFBRTt3QkFDaEQsU0FBUyxHQUFHLCtCQUF1QixDQUFDLFVBQVUsRUFBRSxzQ0FBc0MsRUFBRSxLQUFLLEVBQUUsU0FBUyxDQUFDLENBQUM7cUJBQzdHO29CQUNELElBQUksT0FBTyxDQUFDLDBCQUEwQixJQUFJLE9BQU8sQ0FBQyxvQkFBb0IsS0FBSyxFQUFFLEVBQUU7d0JBQzNFLElBQUkscUJBQXFCLEdBQUcsaUJBQWlCLENBQUMsTUFBTSxDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBakIsQ0FBaUIsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxVQUFBLEdBQUcsSUFBSSxPQUFBLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQWYsQ0FBZSxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEtBQUssRUFBbkIsQ0FBbUIsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxVQUFBLEdBQUcsSUFBSSxPQUFBLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBTixDQUFNLENBQUMsQ0FBQzt3QkFDakssSUFBSSxxQkFBcUIsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLHFCQUFxQixDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTs0QkFDckUsU0FBUyxHQUFHLENBQUMsRUFBRSxHQUFHLHFCQUFxQixDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7eUJBQ3REO3FCQUNKO2lCQUNKO2dCQUNELE9BQU8sc0JBQWMsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUNyQyxDQUFDLEVBQUM7WUFDRiwyQkFBVyxhQUFhLEdBQUcsVUFBVSxlQUFzQixFQUFFLDRCQUFxQyxFQUFFLHFCQUE0QixFQUFFLGdCQUFzQjtnQkFDcEosSUFBSSw0QkFBNEIsRUFBRTtvQkFDOUIsSUFBSSx3QkFBc0IsR0FBRyxnQkFBZ0IsSUFBSSxJQUFJLElBQUksRUFBRSxDQUFDO29CQUM1RCxJQUFJLGlDQUErQixHQUFHLHdCQUFzQixDQUFDLFFBQVEsRUFBRSxHQUFHLEdBQUcsR0FBRyx3QkFBc0IsQ0FBQyxVQUFVLEVBQUUsQ0FBQztvQkFDcEgsSUFBSSxVQUFRLEdBQUcsQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztvQkFDakUsZ0JBQUMsQ0FBQyxJQUFJLENBQUMscUJBQXFCLEVBQUUsVUFBQyxJQUFJO3dCQUMvQixJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxFQUFFLElBQUksSUFBSSxDQUFDLFdBQVc7NEJBQ2hELENBQUMsaUNBQStCLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzs0QkFDakQsQ0FBQyxpQ0FBK0IsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDOzRCQUMvQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUFFLENBQUMsT0FBTyxDQUFDLFVBQVEsQ0FBQyx3QkFBc0IsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7NEJBQ3hGLElBQUksQ0FBQyxTQUFTLEVBQ2hCOzRCQUNFLGVBQWUsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsQ0FBQyxFQUFGLENBQUUsQ0FBQyxDQUFDO3lCQUNuRTtvQkFDTCxDQUFDLENBQUMsQ0FBQztpQkFDTjtnQkFDRCxPQUFPLGVBQWUsSUFBSSxFQUFFLENBQUM7WUFDakMsQ0FBQyxFQUFDO1lBQ0YscUJBQVcsT0FBTyxHQUFHLFVBQVUsc0JBQStCLEVBQUUsb0JBQTRCLEVBQUUsS0FBVTtnQkFDcEcsSUFBSSxJQUFJLEdBQUcsc0JBQXNCLENBQUMsQ0FBQyxDQUFDLG9CQUFvQixJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO2dCQUN0RSxJQUFJLElBQUksSUFBSSxJQUFJLEtBQUssR0FBRyxFQUFFO29CQUN0QixJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFTLEtBQUssQ0FBQyxJQUFNLENBQUMsQ0FBQyxDQUFDLFdBQVMsS0FBSyxDQUFDLElBQU0sQ0FBQyxDQUFDO29CQUNqRixJQUFJLElBQUksU0FBTyxLQUFLLENBQUMsRUFBSSxDQUFDO2lCQUM3QjtnQkFDRCxPQUFPLElBQUksQ0FBQztZQUNoQixDQUFDLEVBQUM7WUFDRixrQ0FBVyxvQkFBb0IsR0FBRyxVQUFVLEtBQWEsRUFBRSxNQUFXO2dCQUNsRSxJQUFJLE1BQU0sR0FBRyxLQUFLLENBQUM7Z0JBQ25CLElBQUksQ0FBQyxLQUFLLElBQUksS0FBSyxLQUFLLENBQUMsQ0FBQyxJQUFJLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLEtBQUssRUFBRSxJQUFJLE1BQU0sQ0FBQyxXQUFXLEtBQUssRUFBRSxDQUFDLEVBQUU7b0JBQzlGLElBQUksTUFBTSxDQUFDLFdBQVcsS0FBSyxFQUFFLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLEVBQUU7d0JBQzVELE1BQU0sR0FBRyxJQUFJLENBQUM7cUJBQ2pCO29CQUNELElBQUksTUFBTSxDQUFDLFdBQVcsS0FBSyxFQUFFLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLEVBQUU7d0JBQzVELE1BQU0sR0FBRyxJQUFJLENBQUM7cUJBQ2pCO2lCQUNKO2dCQUNELE9BQU8sTUFBTSxDQUFDO1lBQ2xCLENBQUMsRUFBQztZQUNGLCtCQUFXLGlCQUFpQixHQUFHLFVBQVUsWUFBb0IsRUFBRSxLQUFLLEVBQUUsY0FBYyxFQUFFLEtBQVUsRUFBRSxRQUFnQixFQUFFLE1BQWMsRUFBRSxXQUFtQixFQUFFLEtBQVksRUFBRSxTQUFpQjtnQkFFcEwsSUFBSSxTQUFTLEdBQUcsZ0JBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksS0FBSyxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ3BGLElBQUksZUFBZSxHQUFHLGdCQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLEtBQUssS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLFFBQVEsRUFBRSxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUVuRyxZQUFZLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQyxJQUFJLE1BQU0sQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLENBQUMsRUFBRSxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ25GLFlBQVksR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDLElBQUksTUFBTSxDQUFDLGlCQUFpQixFQUFFLEdBQUcsQ0FBQyxFQUFFLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDbkYsWUFBWSxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsSUFBSSxNQUFNLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxDQUFDLEVBQUUsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUNuRixZQUFZLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQyxJQUFJLE1BQU0sQ0FBQyxxQkFBcUIsRUFBRSxHQUFHLENBQUMsRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQzNGLFlBQVksR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDLElBQUksTUFBTSxDQUFDLG1CQUFtQixFQUFFLEdBQUcsQ0FBQyxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDdkYsWUFBWSxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsSUFBSSxNQUFNLENBQUMsYUFBYSxFQUFFLEdBQUcsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDO2dCQUUvRSxZQUFZLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQyxJQUFJLE1BQU0sQ0FBQyxhQUFhLEVBQUUsR0FBRyxDQUFDLEVBQUUsa0NBQW1CLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQztnQkFDdEgsWUFBWSxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsSUFBSSxNQUFNLENBQUMsYUFBYSxFQUFFLEdBQUcsQ0FBQyxFQUFFLGtDQUFtQixDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQ3RILFlBQVksR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDLElBQUksTUFBTSxDQUFDLGFBQWEsRUFBRSxHQUFHLENBQUMsRUFBRSxrQ0FBbUIsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUN0SCxZQUFZLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQyxJQUFJLE1BQU0sQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLENBQUMsRUFBRSxrQ0FBbUIsQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUM5SCxZQUFZLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQyxJQUFJLE1BQU0sQ0FBQyxlQUFlLEVBQUUsR0FBRyxDQUFDLEVBQUUsa0NBQW1CLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQztnQkFDMUgsWUFBWSxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsSUFBSSxNQUFNLENBQUMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxFQUFFLGVBQWUsQ0FBQyxDQUFDO2dCQUVqRixJQUFJLFNBQVMsQ0FBQyxXQUFXLEVBQUUsS0FBSyxLQUFLLEVBQUU7b0JBQ25DLFlBQVksR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDLElBQUksTUFBTSxDQUFDLGlCQUFpQixFQUFFLEdBQUcsQ0FBQyxFQUFFLFdBQVcsQ0FBQyxDQUFDO29CQUNyRixZQUFZLEdBQUcsK0JBQXVCLENBQUMsWUFBWSxFQUFFLEtBQUssQ0FBQyxDQUFDO2lCQUMvRDtnQkFFRCxPQUFPLFlBQVksQ0FBQztZQUN4QixDQUFDLEVBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tIFwibG9kYXNoXCI7XHJcblxyXG5pbXBvcnQgeyBnZXRJdGVtQmFzZWRPblRocmVzaG9sZCwgbm9ybWFsaXplQ29sb3IsIHJlcGxhY2VfdGFnc19mcm9tX2ZpZWxkIH0gZnJvbSBcIi4vaW5kZXhcIjtcclxuaW1wb3J0IHsgZ2V0X2Zvcm1hdHRlZF92YWx1ZSB9IGZyb20gXCIuLy4uL0dyYWZhbmFVdGlsc1wiO1xyXG5pbXBvcnQgeyBJQm9vbVBhdHRlcm4gfSBmcm9tIFwiLi9Cb29tLmludGVyZmFjZVwiO1xyXG5cclxuXHJcbmV4cG9ydCBsZXQgZ2V0QkdDb2xvciA9IGZ1bmN0aW9uICh2YWx1ZTogbnVtYmVyLCBwYXR0ZXJuOiBJQm9vbVBhdHRlcm4sIHRocmVzaG9sZHM6IGFueVtdLCBsaXN0X29mX2JnQ29sb3JzX2Jhc2VkX29uX3RocmVzaG9sZHM6IHN0cmluZ1tdLCBiZ0NvbG9yT3ZlclJpZGVzOiBzdHJpbmdbXSk6IHN0cmluZyB7XHJcbiAgICBsZXQgYmdDb2xvciA9IFwidHJhbnNwYXJlbnRcIjtcclxuICAgIGlmIChfLmlzTmFOKHZhbHVlKSB8fCB2YWx1ZSA9PT0gbnVsbCkge1xyXG4gICAgICAgIGJnQ29sb3IgPSBwYXR0ZXJuLm51bGxfY29sb3IgfHwgXCJkYXJrcmVkXCI7XHJcbiAgICAgICAgaWYgKHBhdHRlcm4ubnVsbF9jb2xvciA9PT0gXCJcIikge1xyXG4gICAgICAgICAgICBiZ0NvbG9yID0gXCJ0cmFuc3BhcmVudFwiO1xyXG4gICAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgYmdDb2xvciA9IHBhdHRlcm4uZGVmYXVsdEJHQ29sb3IgfHwgYmdDb2xvcjtcclxuICAgICAgICBpZiAocGF0dGVybi5lbmFibGVfYmdDb2xvciAmJiBwYXR0ZXJuLmJnQ29sb3JzKSB7XHJcbiAgICAgICAgICAgIGJnQ29sb3IgPSBnZXRJdGVtQmFzZWRPblRocmVzaG9sZCh0aHJlc2hvbGRzLCBsaXN0X29mX2JnQ29sb3JzX2Jhc2VkX29uX3RocmVzaG9sZHMsIHZhbHVlLCBiZ0NvbG9yKTtcclxuXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChwYXR0ZXJuLmVuYWJsZV9iZ0NvbG9yX292ZXJyaWRlcyAmJiBwYXR0ZXJuLmJnQ29sb3JzX292ZXJyaWRlcyAhPT0gXCJcIikge1xyXG4gICAgICAgICAgICBsZXQgX2JnQ29sb3JzX292ZXJyaWRlcyA9IGJnQ29sb3JPdmVyUmlkZXMuZmlsdGVyKGNvbiA9PiBjb24uaW5kZXhPZihcIi0+XCIpKS5tYXAoY29uID0+IGNvbi5zcGxpdChcIi0+XCIpKS5maWx0ZXIoY29uID0+ICsoY29uWzBdKSA9PT0gdmFsdWUpLm1hcChjb24gPT4gY29uWzFdKTtcclxuICAgICAgICAgICAgaWYgKF9iZ0NvbG9yc19vdmVycmlkZXMubGVuZ3RoID4gMCAmJiBfYmdDb2xvcnNfb3ZlcnJpZGVzWzBdICE9PSBcIlwiKSB7XHJcbiAgICAgICAgICAgICAgICBiZ0NvbG9yID0gKFwiXCIgKyBfYmdDb2xvcnNfb3ZlcnJpZGVzWzBdKS50cmltKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbm9ybWFsaXplQ29sb3IoYmdDb2xvcik7XHJcbn07XHJcbmV4cG9ydCBsZXQgZ2V0VGV4dENvbG9yID0gZnVuY3Rpb24gKHZhbHVlOiBudW1iZXIsIHBhdHRlcm46IElCb29tUGF0dGVybiwgdGhyZXNob2xkcywgbGlzdF9vZl90ZXh0Q29sb3JzX2Jhc2VkX29uX3RocmVzaG9sZHM6IHN0cmluZywgdHh0Q29sb3JPdmVycmlkZXM6IHN0cmluZ1tdKTogc3RyaW5nIHtcclxuICAgIGxldCB0ZXh0Q29sb3IgPSBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5jb250YWlucyhcInRoZW1lLWxpZ2h0XCIpID8gXCJibGFja1wiIDogXCJ3aGl0ZVwiO1xyXG4gICAgaWYgKF8uaXNOYU4odmFsdWUpIHx8IHZhbHVlID09PSBudWxsKSB7XHJcbiAgICAgICAgdGV4dENvbG9yID0gcGF0dGVybi5udWxsX3RleHRjb2xvciB8fCB0ZXh0Q29sb3I7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRleHRDb2xvciA9IHBhdHRlcm4uZGVmYXVsdFRleHRDb2xvciB8fCB0ZXh0Q29sb3I7XHJcbiAgICAgICAgaWYgKHBhdHRlcm4uZW5hYmxlX3RleHRDb2xvciAmJiBwYXR0ZXJuLnRleHRDb2xvcnMpIHtcclxuICAgICAgICAgICAgdGV4dENvbG9yID0gZ2V0SXRlbUJhc2VkT25UaHJlc2hvbGQodGhyZXNob2xkcywgbGlzdF9vZl90ZXh0Q29sb3JzX2Jhc2VkX29uX3RocmVzaG9sZHMsIHZhbHVlLCB0ZXh0Q29sb3IpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAocGF0dGVybi5lbmFibGVfdGV4dENvbG9yX292ZXJyaWRlcyAmJiBwYXR0ZXJuLnRleHRDb2xvcnNfb3ZlcnJpZGVzICE9PSBcIlwiKSB7XHJcbiAgICAgICAgICAgIGxldCBfdGV4dENvbG9yc19vdmVycmlkZXMgPSB0eHRDb2xvck92ZXJyaWRlcy5maWx0ZXIoY29uID0+IGNvbi5pbmRleE9mKFwiLT5cIikpLm1hcChjb24gPT4gY29uLnNwbGl0KFwiLT5cIikpLmZpbHRlcihjb24gPT4gKyhjb25bMF0pID09PSB2YWx1ZSkubWFwKGNvbiA9PiBjb25bMV0pO1xyXG4gICAgICAgICAgICBpZiAoX3RleHRDb2xvcnNfb3ZlcnJpZGVzLmxlbmd0aCA+IDAgJiYgX3RleHRDb2xvcnNfb3ZlcnJpZGVzWzBdICE9PSBcIlwiKSB7XHJcbiAgICAgICAgICAgICAgICB0ZXh0Q29sb3IgPSAoXCJcIiArIF90ZXh0Q29sb3JzX292ZXJyaWRlc1swXSkudHJpbSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG5vcm1hbGl6ZUNvbG9yKHRleHRDb2xvcik7XHJcbn07XHJcbmV4cG9ydCBsZXQgZ2V0VGhyZXNob2xkcyA9IGZ1bmN0aW9uICh0aHJlc2hvbGRzQXJyYXk6IGFueVtdLCBlbmFibGVfdGltZV9iYXNlZF90aHJlc2hvbGRzOiBib29sZWFuLCB0aW1lX2Jhc2VkX3RocmVzaG9sZHM6IGFueVtdLCBjdXJyZW50VGltZVN0YW1wOiBEYXRlKSB7XHJcbiAgICBpZiAoZW5hYmxlX3RpbWVfYmFzZWRfdGhyZXNob2xkcykge1xyXG4gICAgICAgIGxldCBtZXRyaWNyZWNpdmVkVGltZVN0YW1wID0gY3VycmVudFRpbWVTdGFtcCB8fCBuZXcgRGF0ZSgpO1xyXG4gICAgICAgIGxldCBtZXRyaWNyZWNpdmVkVGltZVN0YW1wX2lubnVtYmVyID0gbWV0cmljcmVjaXZlZFRpbWVTdGFtcC5nZXRIb3VycygpICogMTAwICsgbWV0cmljcmVjaXZlZFRpbWVTdGFtcC5nZXRNaW51dGVzKCk7XHJcbiAgICAgICAgbGV0IHdlZWtkYXlzID0gW1wic3VuXCIsIFwibW9uXCIsIFwidHVlXCIsIFwid2VkXCIsIFwidGh1XCIsIFwiZnJpXCIsIFwic2F0XCJdO1xyXG4gICAgICAgIF8uZWFjaCh0aW1lX2Jhc2VkX3RocmVzaG9sZHMsICh0YnR4KSA9PiB7XHJcbiAgICAgICAgICAgIGlmICh0YnR4ICYmIHRidHguZnJvbSAmJiB0YnR4LnRvICYmIHRidHguZW5hYmxlZERheXMgJiZcclxuICAgICAgICAgICAgICAgIChtZXRyaWNyZWNpdmVkVGltZVN0YW1wX2lubnVtYmVyID49ICsodGJ0eC5mcm9tKSkgJiZcclxuICAgICAgICAgICAgICAgIChtZXRyaWNyZWNpdmVkVGltZVN0YW1wX2lubnVtYmVyIDw9ICsodGJ0eC50bykpICYmXHJcbiAgICAgICAgICAgICAgICAodGJ0eC5lbmFibGVkRGF5cy50b0xvd2VyQ2FzZSgpLmluZGV4T2Yod2Vla2RheXNbbWV0cmljcmVjaXZlZFRpbWVTdGFtcC5nZXREYXkoKV0pID4gLTEpICYmXHJcbiAgICAgICAgICAgICAgICB0YnR4LnRocmVzaG9sZFxyXG4gICAgICAgICAgICApIHtcclxuICAgICAgICAgICAgICAgIHRocmVzaG9sZHNBcnJheSA9ICh0YnR4LnRocmVzaG9sZCArIFwiXCIpLnNwbGl0KFwiLFwiKS5tYXAoZCA9PiArZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIHJldHVybiB0aHJlc2hvbGRzQXJyYXkgfHwgW107XHJcbn07XHJcbmV4cG9ydCBsZXQgZ2V0TGluayA9IGZ1bmN0aW9uIChlbmFibGVfY2xpY2thYmxlX2NlbGxzOiBib29sZWFuLCBjbGlja2FibGVfY2VsbHNfbGluazogc3RyaW5nLCByYW5nZTogYW55KTogc3RyaW5nIHtcclxuICAgIGxldCBsaW5rID0gZW5hYmxlX2NsaWNrYWJsZV9jZWxscyA/IGNsaWNrYWJsZV9jZWxsc19saW5rIHx8IFwiI1wiIDogXCIjXCI7XHJcbiAgICBpZiAobGluayAmJiBsaW5rICE9PSBcIiNcIikge1xyXG4gICAgICAgIGxpbmsgKz0gKGxpbmsuaW5kZXhPZihcIj9cIikgPiAtMSA/IGAmZnJvbT0ke3JhbmdlLmZyb219YCA6IGA/ZnJvbT0ke3JhbmdlLmZyb219YCk7XHJcbiAgICAgICAgbGluayArPSBgJnRvPSR7cmFuZ2UudG99YDtcclxuICAgIH1cclxuICAgIHJldHVybiBsaW5rO1xyXG59O1xyXG5leHBvcnQgbGV0IGRvZXNWYWx1ZU5lZWRzVG9IaWRlID0gZnVuY3Rpb24gKHZhbHVlOiBudW1iZXIsIGZpbHRlcjogYW55KTogYm9vbGVhbiB7XHJcbiAgICBsZXQgaGlkZGVuID0gZmFsc2U7XHJcbiAgICBpZiAoKHZhbHVlIHx8IHZhbHVlID09PSAwKSAmJiBmaWx0ZXIgJiYgKGZpbHRlci52YWx1ZV9iZWxvdyAhPT0gXCJcIiB8fCBmaWx0ZXIudmFsdWVfYWJvdmUgIT09IFwiXCIpKSB7XHJcbiAgICAgICAgaWYgKGZpbHRlci52YWx1ZV9iZWxvdyAhPT0gXCJcIiAmJiB2YWx1ZSA8ICsoZmlsdGVyLnZhbHVlX2JlbG93KSkge1xyXG4gICAgICAgICAgICBoaWRkZW4gPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZmlsdGVyLnZhbHVlX2Fib3ZlICE9PSBcIlwiICYmIHZhbHVlID4gKyhmaWx0ZXIudmFsdWVfYWJvdmUpKSB7XHJcbiAgICAgICAgICAgIGhpZGRlbiA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIGhpZGRlbjtcclxufTtcclxuZXhwb3J0IGxldCBHZXRWYWx1ZXNSZXBsYWNlZCA9IGZ1bmN0aW9uIChzdHJUb1JlcGxhY2U6IHN0cmluZywgdmFsdWUsIHZhbHVlZm9ybWF0dGVkLCBzdGF0czogYW55LCBkZWNpbWFsczogTnVtYmVyLCBmb3JtYXQ6IHN0cmluZywgX21ldHJpY25hbWU6IHN0cmluZywgX3RhZ3M6IGFueVtdLCBkZWxpbWl0ZXI6IHN0cmluZyk6IHN0cmluZyB7XHJcblxyXG4gICAgbGV0IHZhbHVlX3JhdyA9IF8uaXNOYU4odmFsdWUpIHx8IHZhbHVlID09PSBudWxsID8gXCJudWxsXCIgOiB2YWx1ZS50b1N0cmluZygpLnRyaW0oKTtcclxuICAgIGxldCB2YWx1ZV9mb3JtYXR0ZWQgPSBfLmlzTmFOKHZhbHVlKSB8fCB2YWx1ZSA9PT0gbnVsbCA/IFwibnVsbFwiIDogdmFsdWVmb3JtYXR0ZWQudG9TdHJpbmcoKS50cmltKCk7XHJcblxyXG4gICAgc3RyVG9SZXBsYWNlID0gc3RyVG9SZXBsYWNlLnJlcGxhY2UobmV3IFJlZ0V4cChcIl92YWx1ZV9taW5fcmF3X1wiLCBcImdcIiksIHN0YXRzLm1pbik7XHJcbiAgICBzdHJUb1JlcGxhY2UgPSBzdHJUb1JlcGxhY2UucmVwbGFjZShuZXcgUmVnRXhwKFwiX3ZhbHVlX21heF9yYXdfXCIsIFwiZ1wiKSwgc3RhdHMubWF4KTtcclxuICAgIHN0clRvUmVwbGFjZSA9IHN0clRvUmVwbGFjZS5yZXBsYWNlKG5ldyBSZWdFeHAoXCJfdmFsdWVfYXZnX3Jhd19cIiwgXCJnXCIpLCBzdGF0cy5hdmcpO1xyXG4gICAgc3RyVG9SZXBsYWNlID0gc3RyVG9SZXBsYWNlLnJlcGxhY2UobmV3IFJlZ0V4cChcIl92YWx1ZV9jdXJyZW50X3Jhd19cIiwgXCJnXCIpLCBzdGF0cy5jdXJyZW50KTtcclxuICAgIHN0clRvUmVwbGFjZSA9IHN0clRvUmVwbGFjZS5yZXBsYWNlKG5ldyBSZWdFeHAoXCJfdmFsdWVfdG90YWxfcmF3X1wiLCBcImdcIiksIHN0YXRzLnRvdGFsKTtcclxuICAgIHN0clRvUmVwbGFjZSA9IHN0clRvUmVwbGFjZS5yZXBsYWNlKG5ldyBSZWdFeHAoXCJfdmFsdWVfcmF3X1wiLCBcImdcIiksIHZhbHVlX3Jhdyk7XHJcblxyXG4gICAgc3RyVG9SZXBsYWNlID0gc3RyVG9SZXBsYWNlLnJlcGxhY2UobmV3IFJlZ0V4cChcIl92YWx1ZV9taW5fXCIsIFwiZ1wiKSwgZ2V0X2Zvcm1hdHRlZF92YWx1ZShzdGF0cy5taW4sIGRlY2ltYWxzLCBmb3JtYXQpKTtcclxuICAgIHN0clRvUmVwbGFjZSA9IHN0clRvUmVwbGFjZS5yZXBsYWNlKG5ldyBSZWdFeHAoXCJfdmFsdWVfbWF4X1wiLCBcImdcIiksIGdldF9mb3JtYXR0ZWRfdmFsdWUoc3RhdHMubWF4LCBkZWNpbWFscywgZm9ybWF0KSk7XHJcbiAgICBzdHJUb1JlcGxhY2UgPSBzdHJUb1JlcGxhY2UucmVwbGFjZShuZXcgUmVnRXhwKFwiX3ZhbHVlX2F2Z19cIiwgXCJnXCIpLCBnZXRfZm9ybWF0dGVkX3ZhbHVlKHN0YXRzLmF2ZywgZGVjaW1hbHMsIGZvcm1hdCkpO1xyXG4gICAgc3RyVG9SZXBsYWNlID0gc3RyVG9SZXBsYWNlLnJlcGxhY2UobmV3IFJlZ0V4cChcIl92YWx1ZV9jdXJyZW50X1wiLCBcImdcIiksIGdldF9mb3JtYXR0ZWRfdmFsdWUoc3RhdHMuY3VycmVudCwgZGVjaW1hbHMsIGZvcm1hdCkpO1xyXG4gICAgc3RyVG9SZXBsYWNlID0gc3RyVG9SZXBsYWNlLnJlcGxhY2UobmV3IFJlZ0V4cChcIl92YWx1ZV90b3RhbF9cIiwgXCJnXCIpLCBnZXRfZm9ybWF0dGVkX3ZhbHVlKHN0YXRzLnRvdGFsLCBkZWNpbWFscywgZm9ybWF0KSk7XHJcbiAgICBzdHJUb1JlcGxhY2UgPSBzdHJUb1JlcGxhY2UucmVwbGFjZShuZXcgUmVnRXhwKFwiX3ZhbHVlX1wiLCBcImdcIiksIHZhbHVlX2Zvcm1hdHRlZCk7XHJcblxyXG4gICAgaWYgKGRlbGltaXRlci50b0xvd2VyQ2FzZSgpID09PSBcInRhZ1wiKSB7XHJcbiAgICAgICAgc3RyVG9SZXBsYWNlID0gc3RyVG9SZXBsYWNlLnJlcGxhY2UobmV3IFJlZ0V4cChcInt7bWV0cmljX25hbWV9fVwiLCBcImdcIiksIF9tZXRyaWNuYW1lKTtcclxuICAgICAgICBzdHJUb1JlcGxhY2UgPSByZXBsYWNlX3RhZ3NfZnJvbV9maWVsZChzdHJUb1JlcGxhY2UsIF90YWdzKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gc3RyVG9SZXBsYWNlO1xyXG59O1xyXG4iXX0=